---
# OpenAPI: Skybridge Public API (OpenAPI Híbrido - ADR016)
# Versão: 0.3.0
# Descrição: Contrato público HTTP da Skybridge
#    Operações: ESTÁTICAS (definidas neste arquivo)
#    Schemas: DINÂMICOS (gerados do registry runtime)
openapi: 3.1.0
info:
  title: Skybridge Public API
  version: 0.3.0
  description: |
    API pública da Skybridge usando protocolo Sky-RPC v0.3.

    **Modelo Híbrido (ADR016):**
    - **Operações HTTP:** Estáticas (definidas neste YAML)
    - **Schemas:** Dinâmicos (gerados do registry em runtime)

    ## Fluxo de Execução

    1. **Obter ticket:** `GET /ticket?method=context.action`
    2. **Executar operação:** `POST /envelope` com `ticket_id` e `detail`
    3. **Descobrir handlers:** `GET /discover` (introspecção runtime)

    ## Versões do Sky-RPC

    | Versão | Status | Especificação |
    |--------|--------|---------------|
    | v0.1   | Deprecada | - |
    | v0.2   | Experimental | - |
    | v0.3   | Estável | SPEC004 |

  contact:
    name: Skybridge Team
    url: https://github.com/skybridge
  license:
    name: MIT
    identifier: MIT

servers:
  - url: https://cunning-dear-primate.ngrok-free.app
    description: Servidor público via ngrok

security:
  - bearerAuth: []

tags:
  - name: ticket
    description: Operações de ticket
  - name: envelope
    description: Execução RPC
  - name: discovery
    description: Introspecção de handlers
  - name: health
    description: Health checks
  - name: public
    description: Rotas públicas (OpenAPI e Privacy)

paths:
  # ============================================
  # PUBLIC ENDPOINTS
  # ============================================
  /openapi:
    get:
      summary: Obter documento OpenAPI
      description: |
        Retorna o documento OpenAPI completo da API (híbrido).
        Operações são estáticas, schemas são dinâmicos do registry.
      operationId: getOpenAPI
      tags: [public]
      security: []
      responses:
        '200':
          description: Documento OpenAPI em formato YAML
          content:
            application/yaml:
              schema:
                type: string

  /privacy:
    get:
      summary: Obter política de privacidade
      description: |
        Retorna a política de privacidade da Skybridge.
        Esta rota é usada por GPTs personalizados para conformidade com privacidade.
      operationId: getPrivacy
      tags: [public]
      security: []
      responses:
        '200':
          description: Política de privacidade em texto plano
          content:
            text/plain:
              schema:
                type: string

  # ============================================
  # TICKET ENDPOINT
  # ============================================
  /ticket:
    get:
      summary: Criar ticket de execução
      description: |
        Cria um ticket temporário para execução de uma operação RPC.
        O ticket é necessário para chamadas subsequentes a /envelope.
      operationId: createTicket
      tags: [ticket]
      parameters:
        - name: method
          in: query
          required: true
          schema:
            type: string
          description: "Nome do método (ex: fileops.read, health)"
          example: "fileops.read"
      responses:
        '200':
          description: Ticket criado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketResponse'
        '400':
          description: Requisição inválida
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Método não encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ============================================
  # ENVELOPE ENDPOINT
  # ============================================
  /envelope:
    post:
      summary: Executar operação RPC
      description: |
        Executa uma operação RPC usando envelope Sky-RPC v0.3.
        Schemas de request/response são gerados dinamicamente do registry.
      operationId: executeEnvelope
      tags: [envelope]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EnvelopeRequest'
      responses:
        '200':
          description: Operação executada
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnvelopeResponse'
        '400':
          description: Requisição inválida
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Não autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Método não autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Ticket não encontrado ou expirado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '422':
          description: Erro de validação
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ============================================
  # DISCOVERY ENDPOINTS
  # ============================================
  /discover:
    get:
      summary: Listar handlers ativos
      description: |
        Retorna catálogo de handlers RPC carregados no runtime.
        Inclui metadados como method, kind, module, schemas.
      operationId: listHandlers
      tags: [discovery]
      responses:
        '200':
          description: Catálogo de handlers
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SkyRpcDiscovery'
        '401':
          description: Não autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /discover/reload:
    post:
      summary: Recarregar registry de handlers
      description: |
        Força recarga do registry a partir do código atual.
        Requer privilégios de administrador.
      operationId: reloadHandlers
      tags: [discovery]
      responses:
        '200':
          description: Registry recarregado
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  added:
                    type: array
                    items:
                      type: string
                  removed:
                    type: array
                    items:
                      type: string
                  total:
                    type: integer
                  version:
                    type: string
        '401':
          description: Não autenticado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Sem privilégios de administrador
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ============================================
  # HEALTH ENDPOINT
  # ============================================
  /health:
    get:
      summary: Health check
      description: |
        Verifica saúde do sistema.
        Não requer ticket nem autenticação.
      operationId: healthCheck
      tags: [health]
      security: []
      responses:
        '200':
          description: Sistema saudável
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/healthOutput'

# ============================================
# COMPONENTS (SCHEMAS DINÂMICOS)
# ============================================
# Todos os schemas abaixo são PLACEHOLDERS.
# Em runtime, eles são sobrescritos pelos schemas gerados do registry.
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: API Key
      description: |
        Autenticação via Bearer token.

  schemas:
    # Placeholders - sobrescritos dinamicamente
    TicketResponse:
      type: object
      description: "Gerado em runtime"

    EnvelopeRequest:
      type: object
      description: "Gerado em runtime"

    EnvelopeResponse:
      type: object
      description: "Gerado em runtime"

    Error:
      type: object
      description: "Gerado em runtime"

    SkyRpcDiscovery:
      type: object
      description: "Gerado em runtime"

    # Schemas de handlers (definidos estaticamente para validação)
    healthInput:
      type: object
      description: "Health check não requer input"
      properties: {}

    healthOutput:
      type: object
      description: "Resposta do health check"
      properties:
        status:
          type: string
        version:
          type: string
        timestamp:
          type: string
        service:
          type: string

    fileops.readInput:
      type: object
      description: "Parâmetros para leitura de arquivo"
      required:
        - path
      properties:
        path:
          type: string
          description: "Caminho do arquivo para ler"

    fileops.readOutput:
      type: object
      description: "Resultado da leitura do arquivo"
      required:
        - path
        - content
        - size
      properties:
        path:
          type: string
        content:
          type: string
        size:
          type: number
