#!/bin/bash
#
# Git post-commit hook for Skybridge
# ===================================
#
# This hook:
# 1. Notifies the FileTimelineTracker when human commits are made to main/master
# 2. Limpa workspace/core/tmp_path/ após commit bem-sucedido (ADR024)
#

COMMIT_HASH=$(git rev-parse HEAD)
BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Only track commits to main/master/dev branch
# Skip if we're in a worktree (auto-claude branches)
if [[ "$BRANCH" == "main" ]] || [[ "$BRANCH" == "master" ]] || [[ "$BRANCH" == "dev" ]]; then
    # Check if this is the main working directory (not a worktree)
    # Worktrees have a .git file pointing to the main repo, not a .git directory
    if [[ -d ".git" ]]; then
        # Find python executable
        if command -v python3 &> /dev/null; then
            PYTHON=python3
        elif command -v python &> /dev/null; then
            PYTHON=python
        else
            # Python not found, skip silently
            exit 0
        fi

        # Try to notify the tracker
        # Run in background to avoid slowing down commits
        ($PYTHON -m auto_claude.merge.tracker_cli notify-commit "$COMMIT_HASH" 2>/dev/null &) &

        # DOC: ADR024 - Limpa tmp_path após commit bem-sucedido
        TMP_PATH="workspace/core/tmp_path"
        if [[ -d "$TMP_PATH" ]]; then
            rm -rf "$TMP_PATH" && mkdir -p "$TMP_PATH"
        fi

        # Don't let hook failures block commits
        exit 0
    fi
fi

# Not main branch or in worktree, do nothing
exit 0
