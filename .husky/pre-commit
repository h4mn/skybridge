#!/usr/bin/env bash
# Pre-commit hook via Husky
# Executa verificaÃ§Ãµes antes de cada commit

set -e

echo "ðŸ” Running pre-commit checks..."

# Muda para o diretÃ³rio raiz do projeto
cd "$(git rev-parse --show-toplevel)"

# 1. Testes de import (todos os mÃ³dulos)
echo "ðŸ“¦ Running all import tests..."
pytest tests/test_imports.py -v --tb=short

# 2. Todos os testes do projeto
echo "ðŸ§ª Running all tests..."
pytest tests/ -v --tb=short

# 3. Verificar headers UTF-8 (bloqueia commit)
echo "ðŸ“ Checking UTF-8 headers..."
python -c "
import sys
from pathlib import Path

errors = []
for py_file in Path('src').rglob('*.py'):
    content = py_file.read_text(encoding='utf-8', errors='ignore')
    lines = content.split('\\n')[:3]
    if not any('# -*- coding: utf-8 -*-' in line for line in lines):
        if py_file.name != '__init__.py' or len(content) > 500:
            errors.append(str(py_file))

if errors:
    print(f'\\nðŸš¨ Missing UTF-8 header in {len(errors)} files:')
    for error in errors:
        print(f'  - {error}')
    print('\\nAdd # -*- coding: utf-8 -*- at the top of each file.')
    sys.exit(1)
else:
    print('âœ… UTF-8 headers OK')
"

echo "âœ… Pre-commit checks passed!"
